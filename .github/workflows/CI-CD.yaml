name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  docker:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    env:
      CONTAINER_REGISTRY: docker.io
      IMAGE_NAME: myapp
      DOCKER_USERNAME: ${{ vars.DOCKER_USERNAME }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Docker Login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login $CONTAINER_REGISTRY -u "$DOCKER_USERNAME" --password-stdin

      - name: Docker Build
        run: |
          docker build -t $CONTAINER_REGISTRY/$DOCKER_USERNAME/$IMAGE_NAME:latest \
                       -t $CONTAINER_REGISTRY/$DOCKER_USERNAME/$IMAGE_NAME:${{ github.sha }} .

      - name: Docker Push
        run: |
          docker push $CONTAINER_REGISTRY/$DOCKER_USERNAME/$IMAGE_NAME:latest
          docker push $CONTAINER_REGISTRY/$DOCKER_USERNAME/$IMAGE_NAME:${{ github.sha }}



    #   - name: Update GitOps repository
    #     shell: bash
    #     env:
    #       GIT_TOKEN: ${{ secrets.GITOPS_PAT }}
    #     run: |
    #       git config --global credential.helper store
    #       echo "https://${GIT_TOKEN}:x-oauth-basic@github.com" > ~/.git-credentials

    #       rm -rf gitops
    #       git clone https://github.com/rslim087a/grade-api-gitops.git gitops
    #       cd gitops

    #       if [[ "$OSTYPE" == "darwin"* ]]; then
    #         sed -i '' "s|image: .*|image: docker.io/${{ secrets.DOCKER_USERNAME }}/myapp:${{ github.sha }}|g" deployment.yaml
    #       else
    #         sed -i "s|image: .*|image: docker.io/${{ secrets.DOCKER_USERNAME }}/myapp:${{ github.sha }}|g" deployment.yaml
    #       fi

    #       git config --global user.name "GitHub Actions"
    #       git config --global user.email "actions@github.com"
    #       git add deployment.yaml
    #       git commit -m "Update image to ${{ github.sha }}"
    #       git push -f https://${GIT_TOKEN}@github.com/rslim087a/grade-api-gitops.git main
